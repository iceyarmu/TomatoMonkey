# CLAUDE.md - TomatoMonkey å¼€å‘æŒ‡å—

ä¸“ä¸º Claude åŠ©æ‰‹å‡†å¤‡çš„ TomatoMonkey é¡¹ç›®å¼€å‘æ–‡æ¡£ï¼Œç¡®ä¿æ„å»ºé…ç½®å®Œæ•´æ€§å’Œå¼€å‘æµç¨‹ä¸€è‡´æ€§ã€‚

## ğŸ“‹ é¡¹ç›®æ¦‚è§ˆ

TomatoMonkey æ˜¯ä¸“æ³¨æ—¶é—´ç®¡ç†å·¥å…·ï¼Œç»“åˆç•ªèŒ„é’ŸæŠ€æœ¯ä¸ä»»åŠ¡ç®¡ç†ï¼Œä½¿ç”¨ Tampermonkey ç”¨æˆ·è„šæœ¬å®ç°ã€‚

**æ ¸å¿ƒæ¶æ„**:
- **æ„å»ºç³»ç»Ÿ**: Node.js è„šæœ¬å°†æ¨¡å—åŒ–æºç æ‰“åŒ…æˆå•ä¸€ç”¨æˆ·è„šæœ¬
- **æ¨¡å—åŒ–è®¾è®¡**: Core æ¨¡å— + UI ç»„ä»¶ + æ ·å¼ç³»ç»Ÿ
- **å•ä¾‹æ¨¡å¼**: æ‰€æœ‰ç®¡ç†å™¨ç±»ä½¿ç”¨å•ä¾‹æ¨¡å¼ç¡®ä¿å…¨å±€ä¸€è‡´æ€§

## ğŸ”§ æ„å»ºç³»ç»Ÿæ¶æ„ (build/build.js)

### å…³é”®æ„å»ºè§„åˆ™

**âš ï¸ é‡è¦æé†’**: æ¯æ¬¡æ·»åŠ æ–°æ¨¡å—å¿…é¡»åŒæ­¥æ›´æ–°æ„å»ºé…ç½®çš„ 3 ä¸ªä½ç½®ï¼š

1. **æ–‡ä»¶è¯»å–é˜¶æ®µ** (line 100+)
2. **å†…å®¹æå–é˜¶æ®µ** (line 107+) 
3. **è¾“å‡ºæ¨¡æ¿é˜¶æ®µ** (line 141+)

### æ„å»ºæµç¨‹è¯¦è§£

```javascript
// 1. æ–‡ä»¶è¯»å–é˜¶æ®µ - å¿…é¡»ä¸ºæ¯ä¸ªæ–°æ¨¡å—æ·»åŠ 
const newManager = readFile(path.join(SRC_DIR, 'core', 'new-manager.js'));

// 2. å†…å®¹æå–é˜¶æ®µ - å¿…é¡»ä¸ºæ¯ä¸ªæ–°æ¨¡å—æ·»åŠ 
const newManagerContent = extractModuleContent(newManager, 'NewManager');

// 3. è¾“å‡ºæ¨¡æ¿é˜¶æ®µ - å¿…é¡»åœ¨æ­£ç¡®ä½ç½®æ’å…¥
/**
 * NewManager - æ–°ç®¡ç†å™¨æè¿°
 */
${newManagerContent}
```

### æ¨¡å—åŠ è½½é¡ºåº (ä¾èµ–å…³ç³»)

**ä¸¥æ ¼æŒ‰ç…§æ­¤é¡ºåºæ·»åŠ åˆ°æ„å»ºè„šæœ¬**:

```
1. StorageManager      (æœ€åŸºç¡€ï¼Œè¢«æ‰€æœ‰å…¶ä»–ç®¡ç†å™¨ä¾èµ–)
2. WhitelistManager    (ä¾èµ– StorageManager)
3. TaskManager         (ä¾èµ– StorageManager) 
4. SettingsPanel       (ä¾èµ–æ‰€æœ‰ç®¡ç†å™¨)
5. TodoList            (ä¾èµ– TaskManager)
6. TomatoMonkeyApp     (åº”ç”¨ç¨‹åºä¸»ç±»ï¼Œæœ€ååŠ è½½)
```

## ğŸ“ æ–‡ä»¶ç»“æ„è¦æ±‚

### ç›®å½•è§„èŒƒ

```
src/
â”œâ”€â”€ core/                     # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘æ¨¡å—
â”‚   â”œâ”€â”€ storage-manager.js    # æ•°æ®æŒä¹…åŒ–ç®¡ç†å™¨
â”‚   â”œâ”€â”€ whitelist-manager.js  # ç½‘ç«™ç™½åå•ç®¡ç†å™¨  
â”‚   â”œâ”€â”€ task-manager.js       # ä»»åŠ¡ç®¡ç†å™¨
â”‚   â””â”€â”€ [new-manager.js]      # æ–°ç®¡ç†å™¨æ”¾æ­¤ç›®å½•
â”œâ”€â”€ components/               # UI ç»„ä»¶æ¨¡å—
â”‚   â”œâ”€â”€ settings-panel.js     # è®¾ç½®é¢æ¿ç»„ä»¶
â”‚   â”œâ”€â”€ todo-list.js         # ToDoåˆ—è¡¨ç»„ä»¶
â”‚   â””â”€â”€ [new-component.js]    # æ–°ç»„ä»¶æ”¾æ­¤ç›®å½•
â”œâ”€â”€ styles/                   # æ ·å¼æ–‡ä»¶
â”‚   â””â”€â”€ main.css             # ä¸»æ ·å¼æ–‡ä»¶
â””â”€â”€ utils/                    # å·¥å…·å‡½æ•° (å¦‚éœ€è¦)
```

### æ¨¡å—æ–‡ä»¶è§„èŒƒ

**æ¯ä¸ªæ¨¡å—æ–‡ä»¶å¿…é¡»åŒ…å«**:

```javascript
/**
 * ModuleName - æ¨¡å—æè¿°
 * 
 * è´Ÿè´£ï¼š
 * 1. åŠŸèƒ½æè¿°1
 * 2. åŠŸèƒ½æè¿°2
 * 3. åŠŸèƒ½æè¿°3
 */

class ModuleName {
    constructor() {
        // å•ä¾‹æ¨¡å¼å®ç°
        if (ModuleName.instance) {
            return ModuleName.instance;
        }
        ModuleName.instance = this;
    }
    
    // ç±»æ–¹æ³•...
}

// åˆ›å»ºå•ä¾‹å®ä¾‹
const moduleName = new ModuleName();

// å…¨å±€å¯¹è±¡æš´éœ²
if (typeof window !== "undefined") {
    window.ModuleName = ModuleName;
    window.moduleName = moduleName;
}

// æ¨¡å—å¯¼å‡º (æ”¯æŒ CommonJS å’Œ ES6)
if (typeof module !== "undefined" && module.exports) {
    module.exports = { ModuleName, moduleName };
} else if (typeof exports !== "undefined") {
    exports.ModuleName = ModuleName;
    exports.moduleName = moduleName;
}
```

## â• æ–°æ¨¡å—æ·»åŠ æ£€æŸ¥æ¸…å•

### æ·»åŠ æ–°çš„ Core æ¨¡å— (ä¾‹: SecurityManager)

**æ­¥éª¤1: åˆ›å»ºæ¨¡å—æ–‡ä»¶**
- [ ] åœ¨ `src/core/` åˆ›å»º `security-manager.js`
- [ ] å®ç°å•ä¾‹æ¨¡å¼
- [ ] æ·»åŠ å…¨å±€å¯¹è±¡æš´éœ²
- [ ] æ·»åŠ æ¨¡å—å¯¼å‡º

**æ­¥éª¤2: æ›´æ–°æ„å»ºé…ç½® (build/build.js)**
- [ ] æ·»åŠ æ–‡ä»¶è¯»å–: `const securityManager = readFile(...)`
- [ ] æ·»åŠ å†…å®¹æå–: `const securityManagerContent = extractModuleContent(...)`
- [ ] åœ¨æ­£ç¡®ä¾èµ–ä½ç½®æ·»åŠ åˆ°è¾“å‡ºæ¨¡æ¿

**æ­¥éª¤3: éªŒè¯æ„å»º**
- [ ] è¿è¡Œ `npm run build`
- [ ] æ£€æŸ¥ç”Ÿæˆçš„ userscript åŒ…å«æ–°æ¨¡å—
- [ ] éªŒè¯å…¨å±€å¯¹è±¡åˆ›å»º: `grep "window.securityManager"`
- [ ] è¿è¡Œæµ‹è¯•ç¡®ä¿æ— è¯­æ³•é”™è¯¯

### æ·»åŠ æ–°çš„ UI ç»„ä»¶ (ä¾‹: NotificationPanel)

**æ­¥éª¤1-3**: ä¸ Core æ¨¡å—ç›¸åŒ

**æ­¥éª¤4: é›†æˆåˆ°è®¾ç½®é¢æ¿**
- [ ] åœ¨ SettingsPanel ä¸­æ³¨å†Œç»„ä»¶
- [ ] æ·»åŠ æ ‡ç­¾é¡µæˆ–ç•Œé¢å…¥å£
- [ ] æ›´æ–° TomatoMonkeyApp åˆå§‹åŒ–é€»è¾‘

## ğŸ¯ æ„å»ºéªŒè¯æ£€æŸ¥æ¸…å•

### å¿…é¡»éªŒè¯é¡¹ç›®

```bash
# 1. æ„å»ºæˆåŠŸéªŒè¯
npm run build
# âœ… åº”æ˜¾ç¤º: "âœ… Build successful!"

# 2. è¯­æ³•æ£€æŸ¥
node -c tomatomonkey.user.js  
# âœ… åº”æ— è¾“å‡º (æ— è¯­æ³•é”™è¯¯)

# 3. æ¨¡å—åŒ…å«éªŒè¯
grep -n "class YourNewClass" tomatomonkey.user.js
# âœ… åº”æ‰¾åˆ°ç±»å®šä¹‰

# 4. å…¨å±€å¯¹è±¡éªŒè¯  
grep -n "window.yourNewManager" tomatomonkey.user.js
# âœ… åº”æ‰¾åˆ°å…¨å±€å¯¹è±¡åˆ›å»º

# 5. æµ‹è¯•éªŒè¯
npm test
# âœ… æ‰€æœ‰æµ‹è¯•åº”é€šè¿‡

# 6. æ–‡ä»¶å¤§å°æ£€æŸ¥
ls -lh tomatomonkey.user.js
# âœ… æ–‡ä»¶å¤§å°åº”åˆç†å¢é•¿
```

## âš ï¸ å¸¸è§æ„å»ºé™·é˜±

### é™·é˜±1: å¿˜è®°æ·»åŠ åˆ°æ„å»ºé…ç½®
**ç—‡çŠ¶**: æ¨¡å—æ–‡ä»¶å­˜åœ¨ä½†æ„å»ºè¾“å‡ºä¸åŒ…å«
**è§£å†³**: æ£€æŸ¥ build.js çš„ 3 ä¸ªä½ç½®æ˜¯å¦éƒ½å·²æ·»åŠ 

### é™·é˜±2: æ¨¡å—ä¾èµ–é¡ºåºé”™è¯¯  
**ç—‡çŠ¶**: è¿è¡Œæ—¶å‡ºç° "undefined is not a constructor" é”™è¯¯
**è§£å†³**: ç¡®ä¿ä¾èµ–æ¨¡å—åœ¨è¾“å‡ºæ¨¡æ¿ä¸­çš„æ­£ç¡®é¡ºåº

### é™·é˜±3: å…¨å±€å¯¹è±¡æœªåˆ›å»º
**ç—‡çŠ¶**: SettingsPanel åˆå§‹åŒ–å¤±è´¥ï¼Œæç¤ºç®¡ç†å™¨ä¸å­˜åœ¨
**è§£å†³**: æ£€æŸ¥æ¨¡å—æ–‡ä»¶æœ«å°¾çš„å…¨å±€å¯¹è±¡æš´éœ²ä»£ç 

### é™·é˜±4: æ¨¡å—å¯¼å‡ºæ ¼å¼ä¸ä¸€è‡´
**ç—‡çŠ¶**: æµ‹è¯•ç¯å¢ƒä¸­æ¨¡å—å¯¼å…¥å¤±è´¥
**è§£å†³**: ç¡®ä¿ä½¿ç”¨æ ‡å‡†çš„æ¨¡å—å¯¼å‡ºæ¨¡æ¿

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•è¦æ±‚

æ¯ä¸ªæ–°æ¨¡å—éƒ½å¿…é¡»åˆ›å»ºå¯¹åº”æµ‹è¯•æ–‡ä»¶:

```
tests/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ storage-manager.spec.js
â”‚   â”œâ”€â”€ whitelist-manager.spec.js
â”‚   â”œâ”€â”€ task-manager.spec.js
â”‚   â””â”€â”€ [new-manager.spec.js]     # æ–°æ¨¡å—æµ‹è¯•
â””â”€â”€ setup.js                      # æµ‹è¯•ç¯å¢ƒé…ç½®
```

### æµ‹è¯•è¦†ç›–èŒƒå›´è¦æ±‚

- [ ] **æ„é€ å‡½æ•°æµ‹è¯•**: å•ä¾‹æ¨¡å¼éªŒè¯
- [ ] **æ ¸å¿ƒæ–¹æ³•æµ‹è¯•**: ä¸»è¦åŠŸèƒ½éªŒè¯  
- [ ] **é”™è¯¯å¤„ç†æµ‹è¯•**: å¼‚å¸¸æƒ…å†µå¤„ç†
- [ ] **å­˜å‚¨é›†æˆæµ‹è¯•**: å¦‚é€‚ç”¨
- [ ] **äº‹ä»¶ç³»ç»Ÿæµ‹è¯•**: å¦‚é€‚ç”¨

## ğŸ“Š æ„å»ºæ€§èƒ½ç›‘æ§

### æ–‡ä»¶å¤§å°åŸºå‡†

| ç‰ˆæœ¬ | æ–‡ä»¶å¤§å° | æ–°å¢æ¨¡å— |
|------|----------|----------|
| v1.0 | ~95KB   | StorageManager, TaskManager, SettingsPanel, TodoList, WhitelistManager |

**æ€§èƒ½æŒ‡æ ‡**:
- æ„å»ºæ—¶é—´: < 2ç§’
- æ–‡ä»¶å¤§å°: < 150KB (æ¨è)
- æ¨¡å—æ•°é‡: < 10ä¸ª (åˆç†èŒƒå›´)

## ğŸ” è°ƒè¯•æŒ‡å—

### æ„å»ºå¤±è´¥æ’æŸ¥

1. **æ£€æŸ¥æ–‡ä»¶è·¯å¾„**: ç¡®ä¿æ‰€æœ‰è·¯å¾„æ­£ç¡®
2. **éªŒè¯æ¨¡å—è¯­æ³•**: ä½¿ç”¨ `node -c filename.js`
3. **æ£€æŸ¥ä¾èµ–é¡ºåº**: ç¡®è®¤æ¨¡å—åŠ è½½é¡ºåº
4. **æŸ¥çœ‹æ„å»ºæ—¥å¿—**: åˆ†æå…·ä½“é”™è¯¯ä¿¡æ¯

### è¿è¡Œæ—¶é—®é¢˜æ’æŸ¥

1. **å…¨å±€å¯¹è±¡æ£€æŸ¥**: åœ¨æµè§ˆå™¨æ§åˆ¶å°æ£€æŸ¥ `window.yourManager`
2. **æ¨¡å—åˆå§‹åŒ–**: æ£€æŸ¥ SettingsPanel åˆå§‹åŒ–æ—¥å¿—
3. **ä¾èµ–éªŒè¯**: ç¡®è®¤æ‰€æœ‰ä¾èµ–æ¨¡å—å·²æ­£ç¡®åŠ è½½

## ğŸ“ å¼€å‘å·¥ä½œæµ

### æ·»åŠ æ–°åŠŸèƒ½çš„å®Œæ•´æµç¨‹

1. **è§„åˆ’è®¾è®¡**
   - [ ] ç¡®å®šåŠŸèƒ½å½’å± (Core æ¨¡å— vs UI ç»„ä»¶)
   - [ ] è®¾è®¡ä¾èµ–å…³ç³»
   - [ ] ç¡®å®šæ•°æ®æ¨¡å‹

2. **å®ç°å¼€å‘**
   - [ ] åˆ›å»ºæ¨¡å—æ–‡ä»¶ (ä½¿ç”¨æ ‡å‡†æ¨¡æ¿)
   - [ ] å®ç°æ ¸å¿ƒåŠŸèƒ½
   - [ ] æ·»åŠ é”™è¯¯å¤„ç†

3. **æ„å»ºé›†æˆ** 
   - [ ] æ›´æ–° build.js (3ä¸ªä½ç½®)
   - [ ] éªŒè¯æ„å»ºæˆåŠŸ
   - [ ] æ£€æŸ¥è¾“å‡ºè´¨é‡

4. **æµ‹è¯•éªŒè¯**
   - [ ] ç¼–å†™å•å…ƒæµ‹è¯•
   - [ ] è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
   - [ ] æ‰‹å·¥åŠŸèƒ½éªŒè¯

5. **æ–‡æ¡£æ›´æ–°**
   - [ ] æ›´æ–° README (å¦‚éœ€è¦)
   - [ ] æ›´æ–°æ¶æ„æ–‡æ¡£ (å¦‚éœ€è¦)
   - [ ] æ›´æ–°æ­¤ CLAUDE.md (å¦‚æœ‰æ¶æ„å˜æ›´)

## ğŸš¨ ç´§æ€¥ä¿®å¤æŒ‡å—

### WhitelistManager ç¼ºå¤±é—®é¢˜ (å·²ä¿®å¤)

æ­¤é—®é¢˜çš„ä¿®å¤æ¨¡å¼å¯åº”ç”¨äºæ‰€æœ‰ç±»ä¼¼æƒ…å†µ:

```javascript
// build/build.js ä¿®å¤æ¨¡å¼
const newManager = readFile(path.join(SRC_DIR, 'core', 'new-manager.js'));
const newManagerContent = extractModuleContent(newManager, 'NewManager');

// åœ¨è¾“å‡ºæ¨¡æ¿æ­£ç¡®ä½ç½®æ·»åŠ 
/**
 * NewManager - æè¿°
 */
${newManagerContent}
```

### å¿«é€ŸéªŒè¯ä¿®å¤

```bash
npm run build && grep -c "class NewManager" tomatomonkey.user.js
# è¾“å‡ºåº”è¯¥æ˜¯ "1"ï¼Œè¡¨ç¤ºæ‰¾åˆ°ç±»å®šä¹‰
```

---

## ğŸ“š å‚è€ƒèµ„æº

- **æ„å»ºè„šæœ¬**: `build/build.js`
- **é¡¹ç›®ç»“æ„**: `src/` ç›®å½•
- **æµ‹è¯•é…ç½®**: `package.json` Jest é…ç½®
- **è¾“å‡ºæ–‡ä»¶**: `tomatomonkey.user.js`

**é‡è¦æé†’**: æ¯æ¬¡ä¿®æ”¹æ„å»ºç³»ç»Ÿæ—¶ï¼Œè¯·æ›´æ–°æ­¤æ–‡æ¡£ä»¥ä¿æŒåŒæ­¥æ€§ã€‚

---

*æ­¤æ–‡æ¡£æœ€åæ›´æ–°: 2025-09-08*  
*ç‰ˆæœ¬: v1.2 (WhitelistManager é›†æˆå)*