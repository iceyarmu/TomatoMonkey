# Story 1.2: 网站白名单配置

## Status
Draft

## Story
**As a** 需要专注的用户,
**I want** 在设置面板中配置网站白名单,
**so that** 我可以定义专注期间允许访问的网站。

## Acceptance Criteria
1. 在'网站白名单'标签页中，用户可以输入域名并添加到白名单列表中。
2. 用户可以从列表中删除已添加的域名。
3. 白名单采用包含匹配方式（例如 `google.com` 可以匹配 `api.google.com`、`contentgoogle.com`、`google.com.hk`）。
4. 白名单数据在刷新页面后必须持久化。

## Tasks / Subtasks
- [ ] Task 1: 创建 WhitelistManager 核心逻辑模块 (AC: 1, 2, 3, 4)
  - [ ] Subtask 1.1: 在 `src/core/whitelist-manager.js` 中创建 WhitelistManager 单例类
  - [ ] Subtask 1.2: 实现域名添加方法，包含基础验证逻辑
  - [ ] Subtask 1.3: 实现域名删除方法
  - [ ] Subtask 1.4: 实现包含匹配逻辑（contains matching）
  - [ ] Subtask 1.5: 实现域名格式验证（确保输入是有效的域名格式）
  - [ ] Subtask 1.6: 集成 StorageManager 进行数据持久化

- [ ] Task 2: 创建网站白名单 UI 组件 (AC: 1, 2)
  - [ ] Subtask 2.1: 在设置面板中添加'网站白名单'标签页的内容区
  - [ ] Subtask 2.2: 实现域名输入框和添加按钮
  - [ ] Subtask 2.3: 实现白名单列表的渲染逻辑
  - [ ] Subtask 2.4: 为每个域名项添加删除按钮
  - [ ] Subtask 2.5: 添加输入验证的视觉反馈（无效域名时显示错误提示）
  - [ ] Subtask 2.6: 绑定所有事件处理器（添加、删除域名）

- [ ] Task 3: 实现包含匹配和域名匹配算法 (AC: 3)
  - [ ] Subtask 3.1: 实现包含匹配逻辑（检查目标域名是否包含白名单项）
  - [ ] Subtask 3.2: 实现 URL 到域名的提取逻辑
  - [ ] Subtask 3.3: 实现域名匹配测试方法（支持包含匹配）
  - [ ] Subtask 3.4: 添加常见边缘情况处理（如协议、端口、路径的处理）

- [ ] Task 4: 数据持久化集成 (AC: 4)
  - [ ] Subtask 4.1: 扩展 StorageManager 以支持白名单数据存储
  - [ ] Subtask 4.2: 实现页面加载时从存储中恢复白名单数据
  - [ ] Subtask 4.3: 实现白名单变更时自动保存到存储

- [ ] Task 5: 创建单元测试
  - [ ] Subtask 5.1: 在 `tests/core/whitelist-manager.spec.js` 中创建测试用例
  - [ ] Subtask 5.2: 测试域名的添加和删除功能
  - [ ] Subtask 5.3: 测试包含匹配逻辑的各种场景
  - [ ] Subtask 5.4: 测试域名格式验证的边界条件

## Dev Notes

### Previous Story Insights
Story 1.1 已经实现了设置面板的基础框架，包括：
- 左侧垂直导航区域，包含三个标签页入口
- 标签页切换逻辑
- StorageManager 基础实现
- 主要的 CSS 样式框架

本故事需要：
- 复用 Story 1.1 创建的设置面板框架
- 扩展 StorageManager 以支持白名单数据
- 在现有的标签页结构中添加白名单功能

### Data Models
**Settings 数据模型（白名单部分）** [Source: architecture.md#数据模型]:
```typescript
interface Settings {
  pomodoroDuration: number; // 单位：分钟
  whitelist: string[];      // 白名单域名数组
}
```

### Storage Specifications
**存储键值设计** [Source: architecture.md#数据库/存储设计]:
- Key: `TOMATO_MONKEY_SETTINGS`
- Value: `string` (序列化后的 `Settings`)
- 白名单作为 Settings 对象的一部分进行存储

**Tampermonkey API** [Source: architecture.md#技术栈]:
- 继续使用 `GM_setValue` 和 `GM_getValue` 进行数据持久化

### Component Specifications
**白名单 UI 设计** [Source: front-end-spec.md#核心界面布局]:
- 位于设置面板的'网站白名单'标签页中
- 包含域名输入框和添加按钮
- 显示已添加域名的列表
- 每个域名项旁有删除按钮
- 列表操作应有即时反馈

**UI组件规范** [Source: front-end-spec.md#核心组件清单]:
- **输入框**: 用于域名输入。状态包括：默认、获取焦点、错误提示
- **按钮**: 主要按钮（"添加域名"）、次要/文本按钮（"删除"）
- 复用 Story 1.1 定义的按钮和输入框样式

**颜色规范（复用）** [Source: front-end-spec.md#调色板]:
- 主色: `#D95550` - 用于添加按钮
- 辅助色: `#70A85C` - 用于有效域名的视觉反馈
- 错误色: `#E53935` - 用于无效域名提示和删除确认

### File Locations
**项目结构** [Source: architecture.md#项目结构]:
```
src/
├── core/
│   └── whitelist-manager.js    # 白名单管理器（新建）
└── components/
    └── settings-panel.js        # 扩展以包含白名单UI
tests/
└── core/
    └── whitelist-manager.spec.js # 白名单管理器测试（新建）
```

### Technical Constraints
**架构模式** [Source: architecture.md#架构与设计模式]:
- WhitelistManager 以单例模式实现
- 遵循模块化模式，将白名单逻辑独立封装
- UI 观察 WhitelistManager 的状态变化并更新视图

**域名验证规则**:
- 支持标准域名格式（例如：example.com, sub.example.com）
- 采用包含匹配（例如：google.com 匹配 api.google.com, contentgoogle.com, google.com.hk）
- 不需要协议前缀（http:// 或 https://）
- 自动处理大小写（统一转换为小写）

**性能要求** [Source: architecture.md#安全与性能]:
- 网站拦截逻辑必须高效，避免在每个页面加载时造成可感知的延迟
- 域名匹配应在 O(n) 时间复杂度内完成，其中 n 是白名单大小
- 包含匹配使用字符串的 includes() 方法，保持高效

**安全要求** [Source: architecture.md#安全与性能]:
- 域名输入需进行验证，防止注入攻击
- 在渲染域名列表时进行 HTML 转义

**无障碍性要求** [Source: front-end-spec.md#无障碍性]:
- 输入框和按钮都应支持键盘导航
- 删除操作应有确认机制或撤销选项

### Testing Requirements
**测试策略** [Source: architecture.md#测试策略]:
- 使用 Jest 对 WhitelistManager 进行单元测试
- 测试重点：
  - 域名格式验证的各种情况
  - 包含匹配的正确性
  - 数据持久化的可靠性
  - 边界条件处理

**测试场景**:
- 有效域名：example.com, sub.example.com, example.co.uk
- 无效域名：空字符串、包含空格、无效字符
- 包含匹配测试：google.com 应匹配 api.google.com, contentgoogle.com, google.com.hk
- 重复域名处理：防止添加重复的域名

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-08 | 1.0 | Initial story creation | Bob (SM) |
| 2025-09-08 | 1.1 | 修改为 contains 匹配方式，移除通配符支持 | John (PM) |

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_