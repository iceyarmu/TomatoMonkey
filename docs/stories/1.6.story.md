# Story 1.6: 效率统计

## Status
Draft

## Story
**As a** 需要专注的用户,
**I want** 查看我的效率统计数据,
**so that** 我能跟踪我的进展并获得激励。

## Acceptance Criteria
1. 在'效率统计'标签页中，显示四个核心指标：今日完成任务数、累计完成任务数、今日专注分钟数、累计专注分钟数。
2. 页面上有一个图表，以天为单位，显示最近7天内每天完成的任务数和专注分钟数。
3. 所有统计数据都基于已"完成"的任务。

## Tasks / Subtasks
- [ ] Task 1: 创建 StatsManager 统计管理模块 (AC: 1, 3)
  - [ ] Subtask 1.1: 在 `src/core/stats-manager.js` 中创建 StatsManager 单例类
  - [ ] Subtask 1.2: 实现会话数据的收集和存储
  - [ ] Subtask 1.3: 实现今日数据的计算方法
  - [ ] Subtask 1.4: 实现累计数据的计算方法
  - [ ] Subtask 1.5: 实现按日期聚合数据的方法
  - [ ] Subtask 1.6: 实现数据清理机制（保留最近30天数据）

- [ ] Task 2: 集成 Chart.js 图表库 (AC: 2)
  - [ ] Subtask 2.1: 在主入口文件中引入 Chart.js 库（CDN 或内嵌）
  - [ ] Subtask 2.2: 配置 Chart.js 的基础设置
  - [ ] Subtask 2.3: 创建图表配置模板（双Y轴：任务数和分钟数）
  - [ ] Subtask 2.4: 实现响应式图表尺寸调整

- [ ] Task 3: 创建统计页面 UI (AC: 1, 2)
  - [ ] Subtask 3.1: 在设置面板中添加'效率统计'标签页内容
  - [ ] Subtask 3.2: 创建四个核心指标的显示卡片
  - [ ] Subtask 3.3: 添加图表容器
  - [ ] Subtask 3.4: 实现指标卡片的样式设计
  - [ ] Subtask 3.5: 添加数据刷新机制

- [ ] Task 4: 实现数据可视化 (AC: 2)
  - [ ] Subtask 4.1: 准备最近7天的数据数组
  - [ ] Subtask 4.2: 配置双Y轴图表（左轴：任务数，右轴：分钟数）
  - [ ] Subtask 4.3: 实现折线图或柱状图渲染
  - [ ] Subtask 4.4: 添加图表交互（hover显示详情）
  - [ ] Subtask 4.5: 处理无数据情况的显示

- [ ] Task 5: 数据收集集成 (AC: 3)
  - [ ] Subtask 5.1: 在任务完成时记录统计数据
  - [ ] Subtask 5.2: 在会话结束时更新专注时间
  - [ ] Subtask 5.3: 确保只统计"完成"状态的任务
  - [ ] Subtask 5.4: 处理跨天的会话（午夜边界）
  - [ ] Subtask 5.5: 实现数据的实时更新

- [ ] Task 6: 数据持久化 (AC: 1, 2, 3)
  - [ ] Subtask 6.1: 设计统计数据的存储结构
  - [ ] Subtask 6.2: 实现统计数据的保存和加载
  - [ ] Subtask 6.3: 处理数据迁移和版本兼容
  - [ ] Subtask 6.4: 实现数据导出功能（可选）

- [ ] Task 7: 优化和增强
  - [ ] Subtask 7.1: 添加加载状态指示器
  - [ ] Subtask 7.2: 实现数据缓存以提高性能
  - [ ] Subtask 7.3: 添加时间段筛选（今日/本周/本月）
  - [ ] Subtask 7.4: 添加趋势指示器（上升/下降箭头）

- [ ] Task 8: 创建测试
  - [ ] Subtask 8.1: 在 `tests/core/stats-manager.spec.js` 中创建单元测试
  - [ ] Subtask 8.2: 测试数据聚合的正确性
  - [ ] Subtask 8.3: 测试日期边界处理
  - [ ] Subtask 8.4: 手动测试图表渲染和交互

## Dev Notes

### Previous Story Insights
从已完成的故事中获得的基础：
- Story 1.1: 设置面板框架，标签页切换机制
- Story 1.3: TimerManager 提供专注时间数据
- Story 1.5: SessionRecord 提供会话记录数据

本故事需要：
- 汇总所有历史数据生成统计
- 集成 Chart.js 进行数据可视化
- 在设置面板的第三个标签页实现统计UI

### Data Models
**统计数据模型**:
```typescript
// 来自 Story 1.5
interface SessionRecord {
  id: string;
  taskId: string;
  taskTitle: string;
  startTime: number;
  endTime: number;
  duration: number;
  plannedDuration: number;
  outcome: 'completed' | 'abandoned' | 'continued';
  isTaskCompleted: boolean;
}

// 新增：日统计数据
interface DailyStats {
  date: string;              // YYYY-MM-DD 格式
  completedTaskCount: number;
  totalFocusMinutes: number;
  sessionCount: number;
  sessions: SessionRecord[];
}

// 新增：统计汇总数据
interface StatsSummary {
  todayCompletedTasks: number;
  totalCompletedTasks: number;
  todayFocusMinutes: number;
  totalFocusMinutes: number;
  last7Days: DailyStats[];
  currentStreak: number;      // 连续天数
}
```

### Chart Configuration
**Chart.js 配置** [Source: architecture.md#技术栈]:
- 版本: Chart.js 4.x
- 引入方式: CDN 或按需模块化引入
- 图表类型: 混合图表（柱状图 + 折线图）

**图表设计规范**:
```javascript
const chartConfig = {
  type: 'bar',
  data: {
    labels: ['周一', '周二', '周三', '周四', '周五', '周六', '周日'],
    datasets: [{
      label: '完成任务数',
      type: 'bar',
      data: [],
      backgroundColor: '#70A85C',
      yAxisID: 'y-tasks'
    }, {
      label: '专注分钟数',
      type: 'line',
      data: [],
      borderColor: '#D95550',
      yAxisID: 'y-minutes'
    }]
  },
  options: {
    responsive: true,
    scales: {
      'y-tasks': {
        type: 'linear',
        position: 'left',
        title: { text: '任务数' }
      },
      'y-minutes': {
        type: 'linear',
        position: 'right',
        title: { text: '分钟' }
      }
    }
  }
}
```

### Component Specifications
**统计页面布局** [Source: front-end-spec.md#核心界面布局]:
- 顶部：四个核心指标卡片（2x2网格布局）
- 中部：7天趋势图表
- 底部：额外统计信息（可选）

**指标卡片设计** [Source: front-end-spec.md#核心组件清单]:
- 卡片背景: `#F5F5F5` (浅灰背景)
- 数字字体: 32px，粗体
- 标签字体: 14px，`#666666`
- 今日数据用主色 `#D95550` 强调
- 累计数据用中性色 `#666666`

**图表容器规范** [Source: front-end-spec.md#核心组件清单]:
- 宽度: 100% 容器宽度
- 高度: 300px（固定高度）
- 背景: 白色
- 边框: 1px solid `#BBBBBB`
- 内边距: 20px

### File Locations
**项目结构** [Source: architecture.md#项目结构]:
```
src/
├── core/
│   └── stats-manager.js       # 统计管理器（新建）
├── components/
│   └── settings-panel.js      # 扩展以添加统计UI
└── styles/
    └── main.css               # 更新以包含统计样式
tests/
└── core/
    └── stats-manager.spec.js  # 统计管理器测试（新建）
```

### Technical Constraints
**架构模式** [Source: architecture.md#架构与设计模式]:
- StatsManager 以单例模式实现
- 观察 TaskManager 和 TimerManager 的事件
- 使用模块化方式组织统计逻辑

**性能要求** [Source: front-end-spec.md#性能考量]:
- 图表库应按需加载，以加快初始渲染速度
- 避免在每次切换到统计标签时重新计算所有数据
- 实现数据缓存机制

**数据处理要求**:
- 时区处理：使用用户本地时区
- 日期边界：以午夜0点为界
- 数据保留：默认保留30天数据
- 实时更新：任务完成后立即更新统计

**Chart.js 集成注意事项**:
- 使用轻量级配置，避免引入不必要的功能
- 确保图表响应式，适应容器大小变化
- 处理无数据情况，显示友好提示

### Storage Specifications
**存储键值设计** [Source: architecture.md#数据库/存储设计]:
- Key: `TOMATO_MONKEY_SESSIONS`
  - Value: `string` (序列化后的 `SessionRecord[]`)
- Key: `TOMATO_MONKEY_DAILY_STATS`
  - Value: `string` (序列化后的 `DailyStats[]`)

### Testing Requirements
**测试策略** [Source: architecture.md#测试策略]:
- 单元测试 StatsManager 的数据处理逻辑
- 手动测试图表渲染和交互

**测试场景**:
1. **数据计算测试**:
   - 今日数据计算准确性
   - 累计数据计算准确性
   - 7天数据聚合正确性
2. **日期边界测试**:
   - 跨天会话处理
   - 时区处理
   - 月末/年末边界
3. **图表测试**:
   - 数据正确映射到图表
   - 无数据时的显示
   - 图表交互响应
4. **性能测试**:
   - 大量数据时的渲染性能
   - 数据更新的响应速度
   - 内存使用情况
5. **边缘情况**:
   - 无任何完成任务
   - 只有今天的数据
   - 数据迁移兼容性

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-08 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_