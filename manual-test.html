<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TomatoMonkey Manual Test</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #D95550;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #D95550;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #c44540;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
    </style>
</head>
<body>
    <h1>üçÖ TomatoMonkey Manual Test</h1>
    
    <div class="test-section">
        <h2>Test 1: StorageManager Methods</h2>
        <button class="test-button" onclick="testStorage()">Test Storage Methods</button>
        <div id="storage-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>Test 2: Timer Start Without Crash</h2>
        <button class="test-button" onclick="testTimerStart()">Start Timer (5 seconds)</button>
        <button class="test-button" onclick="stopTimer()">Stop Timer</button>
        <div id="timer-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>Test 3: XSS Protection</h2>
        <button class="test-button" onclick="testXSS()">Test XSS Protection</button>
        <div id="xss-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>Test 4: Focus Page Display</h2>
        <button class="test-button" onclick="testFocusPage()">Show Focus Page</button>
        <button class="test-button" onclick="hideFocusPage()">Hide Focus Page</button>
        <div id="focus-result" class="result"></div>
    </div>

    <!-- Mock GM functions -->
    <script>
        // Mock Tampermonkey functions
        window.GM_setValue = function(key, value) {
            localStorage.setItem('GM_' + key, JSON.stringify(value));
            return true;
        };
        
        window.GM_getValue = function(key, defaultValue) {
            const value = localStorage.getItem('GM_' + key);
            if (value === null) return defaultValue;
            try {
                return JSON.parse(value);
            } catch {
                return defaultValue;
            }
        };
        
        window.unsafeWindow = window;
    </script>

    <!-- Load the built userscript -->
    <script src="tomatomonkey.user.js"></script>

    <script>
        function log(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = isError ? 'error' : 'success';
            element.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            element.scrollTop = element.scrollHeight;
        }

        // Test 1: StorageManager
        function testStorage() {
            const resultId = 'storage-result';
            document.getElementById(resultId).innerHTML = '';
            
            try {
                // Access StorageManager
                const sm = window.storageManager;
                if (!sm) {
                    throw new Error('StorageManager not found');
                }
                log(resultId, '‚úì StorageManager instance found');

                // Test new methods
                sm.setData('test_key', {value: 'test_data'});
                log(resultId, '‚úì setData() executed without error');

                const data = sm.getData('test_key');
                if (data && data.value === 'test_data') {
                    log(resultId, '‚úì getData() returned correct data');
                } else {
                    throw new Error('getData() returned incorrect data');
                }

                sm.removeData('test_key');
                log(resultId, '‚úì removeData() executed without error');

                const removedData = sm.getData('test_key');
                if (removedData === null) {
                    log(resultId, '‚úì Data successfully removed');
                } else {
                    throw new Error('Data was not removed');
                }

                log(resultId, '‚úÖ ALL STORAGE TESTS PASSED - PERSIST-002 FIXED');
            } catch (error) {
                log(resultId, `‚ùå Error: ${error.message}`, true);
            }
        }

        // Test 2: Timer Start
        let timerManager = null;
        function testTimerStart() {
            const resultId = 'timer-result';
            document.getElementById(resultId).innerHTML = '';
            
            try {
                // Get TimerManager
                timerManager = window.TimerManager ? window.TimerManager.getInstance() : null;
                if (!timerManager) {
                    throw new Error('TimerManager not found');
                }
                log(resultId, '‚úì TimerManager instance found');

                // Initialize with storage manager
                timerManager.initialize(window.storageManager);
                log(resultId, '‚úì TimerManager initialized');

                // Add observer to track events
                timerManager.addObserver((event, data) => {
                    log(resultId, `Event: ${event} - ${JSON.stringify(data)}`);
                });

                // Start timer (5 seconds for quick test)
                const started = timerManager.startTimer('test-task-1', 'Test Task <script>alert("XSS")</script>', 5);
                if (started) {
                    log(resultId, '‚úÖ TIMER STARTED WITHOUT CRASH - AC3 SHOULD WORK');
                } else {
                    throw new Error('Timer failed to start');
                }

            } catch (error) {
                log(resultId, `‚ùå Error: ${error.message}`, true);
            }
        }

        function stopTimer() {
            if (timerManager) {
                timerManager.stopTimer();
                log('timer-result', '‚úì Timer stopped');
            }
        }

        // Test 3: XSS Protection
        function testXSS() {
            const resultId = 'xss-result';
            document.getElementById(resultId).innerHTML = '';
            
            try {
                const maliciousTitle = '<img src=x onerror="alert(\'XSS\')">Malicious Task';
                
                // Test TimerManager fallback notification
                const tm = window.TimerManager ? window.TimerManager.getInstance() : null;
                if (tm) {
                    tm.showFallbackNotification('Test', maliciousTitle);
                    log(resultId, '‚úì TimerManager fallback notification rendered (check for XSS)');
                }

                // Test FocusPage completion message
                const fp = new window.FocusPage();
                fp.initialize(tm);
                
                // Create a temporary container for testing
                const testContainer = document.createElement('div');
                testContainer.innerHTML = '<div class="focus-hint"></div>';
                fp.container = testContainer;
                
                fp.showCompletionMessage(maliciousTitle);
                
                // Check if the malicious content was escaped
                const content = testContainer.textContent;
                if (content.includes('<img') || content.includes('onerror')) {
                    throw new Error('XSS vulnerability detected!');
                }
                
                log(resultId, '‚úì FocusPage completion message escaped properly');
                log(resultId, '‚úÖ XSS PROTECTION WORKING - SEC-003 FIXED');

            } catch (error) {
                log(resultId, `‚ùå Error: ${error.message}`, true);
            }
        }

        // Test 4: Focus Page
        let focusPage = null;
        function testFocusPage() {
            const resultId = 'focus-result';
            document.getElementById(resultId).innerHTML = '';
            
            try {
                if (!window.FocusPage) {
                    throw new Error('FocusPage not found');
                }
                
                focusPage = new window.FocusPage();
                const tm = window.TimerManager ? window.TimerManager.getInstance() : null;
                focusPage.initialize(tm);
                
                log(resultId, '‚úì FocusPage initialized');
                
                // Simulate timer start event
                focusPage.onTimerStarted({
                    taskTitle: 'Test Task',
                    remainingSeconds: 1500,
                    totalSeconds: 1500
                });
                
                log(resultId, '‚úì Focus page shown');
                log(resultId, '‚úÖ FOCUS PAGE DISPLAY WORKING');

            } catch (error) {
                log(resultId, `‚ùå Error: ${error.message}`, true);
            }
        }

        function hideFocusPage() {
            if (focusPage) {
                focusPage.hide();
                log('focus-result', '‚úì Focus page hidden');
            }
        }

        // Auto-run storage test on load
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(testStorage, 500);
        });
    </script>
</body>
</html>